{% extends "base.html" %}

{% block title %}Reports - Reimbursement System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-10 mx-auto">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-file-earmark-text"></i> Generate Reports</h1>
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                <i class="bi bi-house"></i> Dashboard
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-10 mx-auto">
        <!-- Report Generation Form -->
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-download"></i> Export Data</h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    {{ form.hidden_tag() }}
                    
                    <!-- Report Type -->
                    <div class="mb-4">
                        <label for="{{ form.report_type.id }}" class="form-label">
                            {{ form.report_type.label.text }} <span class="text-danger">*</span>
                        </label>
                        {{ form.report_type(class="form-select") }}
                        {% if form.report_type.errors %}
                            <div class="text-danger small">
                                {% for error in form.report_type.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                        <!-- Report Type Descriptions -->
                        <div class="mt-3">
                            <div class="report-description" data-type="comprehensive_excel_report">
                                <div class="alert alert-primary">
                                    <h6><i class="bi bi-archive"></i> Comprehensive Excel Report (All-in-One ZIP)</h6>
                                    <p class="mb-0">Generates a complete ZIP file containing: separate Excel ISD Reimbursement forms per month using the professional template, combined Financial Office Expense report, and all receipts renamed as "uuid_Attachment01". Perfect for complete submissions with professional formatting.</p>
                                </div>
                            </div>
                            <div class="report-description" data-type="multi_isd_excel" style="display: none;">
                                <div class="alert alert-success">
                                    <h6><i class="bi bi-file-earmark-excel"></i> ISD Reimbursement Forms (Separate per month)</h6>
                                    <p class="mb-0">Generates separate ISD Reimbursement Excel files for each month that contains selected claims. Each file uses the professional ISD template with proper formatting, multiple currency support, and month-by-month organization.</p>
                                </div>
                            </div>
                            <div class="report-description" data-type="multi_financial_expense" style="display: none;">
                                <div class="alert alert-warning">
                                    <h6><i class="bi bi-file-earmark-text"></i> Financial Office Expense Form (Combined)</h6>
                                    <p class="mb-0">Generates a single CSV file with one row per selected claim, combining all selected claims regardless of month. Includes dates, descriptions, amounts, and expense groups.</p>
                                </div>
                            </div>
                            <div class="report-description" data-type="isd_reimbursement" style="display: none;">
                                <div class="alert alert-light">
                                    <h6><i class="bi bi-file-earmark-excel"></i> ISD Reimbursement Form - Excel (Single month)</h6>
                                    <p class="mb-0">Generates a professional Excel file using the ISD template with individual expense items for the selected month. 
                                    Features proper formatting, multi-currency columns, automatic totals, and template-based layout suitable for official submission.</p>
                                </div>
                            </div>
                            <div class="report-description" data-type="financial_expense" style="display: none;">
                                <div class="alert alert-light">
                                    <h6><i class="bi bi-info-circle"></i> Financial Office Expense Form (Single month)</h6>
                                    <p class="mb-0">Generates a CSV file with one row per claim for the selected month only. 
                                    Includes dates, combined descriptions, amounts, expense groups, alias names, and claim UUIDs.</p>
                                </div>
                            </div>
                            <div class="report-description" data-type="receipts_export" style="display: none;">
                                <div class="alert alert-light">
                                    <h6><i class="bi bi-info-circle"></i> Receipts Export (ZIP)</h6>
                                    <p class="mb-0">Creates a ZIP file containing all receipt files for the selected month. 
                                    Files are renamed to include the alias name and claim UUID for easy identification.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Selection Mode Toggle -->
                    <div class="mb-4">
                        <div class="btn-group d-flex" role="group" aria-label="Selection mode">
                            <input type="radio" class="btn-check" name="selection_mode" id="mode_claims" value="claims" checked>
                            <label class="btn btn-outline-primary" for="mode_claims">
                                <i class="bi bi-check2-square"></i> Select Specific Claims
                            </label>
                            <input type="radio" class="btn-check" name="selection_mode" id="mode_month" value="month">
                            <label class="btn btn-outline-secondary" for="mode_month">
                                <i class="bi bi-calendar-month"></i> Select by Month/Year
                            </label>
                        </div>
                    </div>

                    <!-- Claims Selection (New Mode) -->
                    <div class="mb-4" id="claims_selection">
                        <label class="form-label">
                            <i class="bi bi-list-check"></i> Select Claims <span class="text-danger">*</span>
                        </label>
                        {% if form.selected_claims.choices %}
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="selectAllClaims()">
                                            <i class="bi bi-check-all"></i> Select All
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearAllClaims()">
                                            <i class="bi bi-x-square"></i> Clear All
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="claims-checkbox-container" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 1rem;">
                                {% for subfield in form.selected_claims %}
                                    <div class="form-check mb-2">
                                        {{ subfield(class="form-check-input") }}
                                        {{ subfield.label(class="form-check-label") }}
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i> No claims available. Please create some claims first.
                            </div>
                        {% endif %}
                        {% if form.selected_claims.errors %}
                            <div class="text-danger small mt-2">
                                {% for error in form.selected_claims.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Month and Year Selection (Legacy Mode) -->
                    <div class="mb-4" id="month_selection" style="display: none;">
                        <label for="{{ form.month_year.id }}" class="form-label">
                            <i class="bi bi-calendar3"></i> {{ form.month_year.label.text }} <span class="text-danger">*</span>
                        </label>
                        {{ form.month_year(class="form-select") }}
                        {% if form.month_year.errors %}
                            <div class="text-danger small">
                                {% for error in form.month_year.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">
                            Only months with existing expense claims are shown.
                            {% if not form.month_year.choices %}
                                <span class="text-warning">No expense data found. Please create some claims first.</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid">
                        {% if form.selected_claims.choices or form.month_year.choices %}
                            {{ form.submit(class="btn btn-primary btn-lg") }}
                        {% else %}
                            <button type="button" class="btn btn-secondary btn-lg" disabled>
                                No Data Available
                            </button>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>

        <!-- Report Information -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card border-info">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="bi bi-lightbulb"></i> Report Types Explained</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Multi-Claim Reports (Recommended)</h6>
                                <ul class="small text-muted mb-3">
                                    <li><strong>Comprehensive Report:</strong> All-in-one ZIP with ISD forms per month, combined financial report, and renamed receipts</li>
                                    <li><strong>Multi-ISD Reports:</strong> Separate ISD forms for each month that contains selected claims</li>
                                    <li><strong>Combined Financial:</strong> Single financial report combining all selected claims</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Single-Month Reports (Legacy)</h6>
                                <ul class="small text-muted mb-3">
                                    <li><strong>ISD Reimbursement:</strong> One row per expense item for a specific month</li>
                                    <li><strong>Financial Expense:</strong> One row per claim for a specific month</li>
                                    <li><strong>Receipts Export:</strong> ZIP file with all receipts for a specific month</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="card mt-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="d-grid">
                            <a href="{{ url_for('claims_list') }}" class="btn btn-outline-primary">
                                <i class="bi bi-list-ul"></i> View All Claims
                            </a>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-grid">
                            <a href="{{ url_for('new_claim') }}" class="btn btn-success">
                                <i class="bi bi-plus-circle"></i> New Claim
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const reportTypeSelect = document.getElementById('{{ form.report_type.id }}');
    const descriptions = document.querySelectorAll('.report-description');
    const claimsMode = document.getElementById('mode_claims');
    const monthMode = document.getElementById('mode_month');
    const claimsSelection = document.getElementById('claims_selection');
    const monthSelection = document.getElementById('month_selection');
    
    // Handle selection mode toggle
    function toggleSelectionMode() {
        if (claimsMode.checked) {
            claimsSelection.style.display = 'block';
            monthSelection.style.display = 'none';
            // Update report type options for multi-claim mode
            updateReportTypeOptions('claims');
        } else {
            claimsSelection.style.display = 'none';
            monthSelection.style.display = 'block';
            // Update report type options for single-month mode
            updateReportTypeOptions('month');
        }
    }
    
    function updateReportTypeOptions(mode) {
        const select = reportTypeSelect;
        const currentValue = select.value;
        
        // Clear existing options
        select.innerHTML = '';
        
        if (mode === 'claims') {
            // Multi-claim options
            const options = [
                ['comprehensive_excel_report', 'Comprehensive Excel Report (ISD per month + Combined Financial + Receipts)'],
                ['multi_isd_excel', 'ISD Reimbursement Forms - Excel (Separate per month)'],
                ['multi_financial_expense', 'Financial Office Expense Form (Combined)']
            ];
            options.forEach(([value, text]) => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = text;
                if (value === currentValue) option.selected = true;
                select.appendChild(option);
            });
            // Default to comprehensive if current value not available
            if (!select.value) select.value = 'comprehensive_excel_report';
        } else {
            // Single-month options
            const options = [
                ['isd_reimbursement', 'ISD Reimbursement Form - Excel (Single month)'],
                ['financial_expense', 'Financial Office Expense Form (Single month)'],
                ['receipts_export', 'Receipts Export (ZIP)']
            ];
            options.forEach(([value, text]) => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = text;
                if (value === currentValue) option.selected = true;
                select.appendChild(option);
            });
            // Default to isd_reimbursement if current value not available
            if (!select.value) select.value = 'isd_reimbursement';
        }
        
        showDescription();
    }
    
    function showDescription() {
        descriptions.forEach(desc => desc.style.display = 'none');
        const selectedType = reportTypeSelect.value;
        const targetDesc = document.querySelector(`[data-type="${selectedType}"]`);
        if (targetDesc) {
            targetDesc.style.display = 'block';
        }
    }
    
    // Event listeners
    claimsMode.addEventListener('change', toggleSelectionMode);
    monthMode.addEventListener('change', toggleSelectionMode);
    reportTypeSelect.addEventListener('change', showDescription);
    
    // Initialize
    toggleSelectionMode();
    showDescription();
    
    // Form submission handling
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const reportType = reportTypeSelect.value;
            
            if (claimsMode.checked) {
                // Check if at least one claim is selected
                const selectedClaims = document.querySelectorAll('input[name="selected_claims"]:checked');
                if (selectedClaims.length === 0) {
                    e.preventDefault();
                    alert('Please select at least one claim to generate the report.');
                    return;
                }
            } else {
                // Check if month/year is selected
                const monthYear = document.getElementById('{{ form.month_year.id }}').value;
                if (!monthYear) {
                    e.preventDefault();
                    alert('Please select a month/year to generate the report.');
                    return;
                }
            }
            
            // Show loading state
            const submitBtn = document.querySelector('button[type="submit"], input[type="submit"]');
            if (submitBtn) {
                const originalText = submitBtn.innerHTML || submitBtn.value;
                if (submitBtn.tagName === 'BUTTON') {
                    submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Generating...';
                } else {
                    submitBtn.value = 'Generating...';
                }
                submitBtn.disabled = true;
                
                // Reset button after a delay (in case of errors)
                setTimeout(function() {
                    if (submitBtn.tagName === 'BUTTON') {
                        submitBtn.innerHTML = originalText;
                    } else {
                        submitBtn.value = originalText;
                    }
                    submitBtn.disabled = false;
                }, 15000);
            }
        });
    }
});

// Helper functions for claim selection
function selectAllClaims() {
    const checkboxes = document.querySelectorAll('input[name="selected_claims"]');
    checkboxes.forEach(cb => cb.checked = true);
}

function clearAllClaims() {
    const checkboxes = document.querySelectorAll('input[name="selected_claims"]');
    checkboxes.forEach(cb => cb.checked = false);
}
</script>
{% endblock %}
